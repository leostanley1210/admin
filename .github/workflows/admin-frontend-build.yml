name: Frontend CI/CD

on:
  push:
    branches:
      - '**'
    tags:
      - '**'

env:
  CONTAINER_REGISTRY: ${{ secrets.CONTAINER_REGISTRY }}
  GITHUB_REPO_NAME: ${{ github.repository }}
  
  PREVIEW_PROJECT: preview
  STAGE_PROJECT: stage
  LIVE_PROJECT: live

  harbor_preview_user: ${{ secrets.harbor_preview_user }}
  harbor_preview_pass: ${{ secrets.harbor_preview_pass }}
  harbor_stage_user: ${{ secrets.harbor_stage_user }}
  harbor_stage_pass: ${{ secrets.harbor_stage_pass }}
  harbor_live_user: ${{ secrets.harbor_live_user }}
  harbor_live_pass: ${{ secrets.harbor_live_pass }}

jobs:
  frontend-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build React/Vite App
        run: npm run build

      - name: Determine branch & Harbor environment
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          TAG_NAME=${GITHUB_REF#refs/tags/}

          # Default component name = repo name
          COMPONENT_NAME=$(basename $GITHUB_REPO_NAME)
          COMPONENT_NAME=$(echo "$COMPONENT_NAME" | tr '[:upper:]' '[:lower:]')

          if [[ "$TAG_NAME" != "$GITHUB_REF" ]]; then
            # Triggered by tag → live
            ENV_NAME="live"
            HARBOR_PROJECT="$LIVE_PROJECT"
            IMAGE_TAG="$TAG_NAME"
            HARBOR_USER=$harbor_live_user
            HARBOR_PASS=$harbor_live_pass
          elif [[ "$BRANCH_NAME" == "main" ]]; then
            # Main branch without tag → stage
            ENV_NAME="stage"
            HARBOR_PROJECT="$STAGE_PROJECT"
            IMAGE_TAG="stage"
            HARBOR_USER=$harbor_stage_user
            HARBOR_PASS=$harbor_stage_pass
          else
            # Feature or other branch → preview
            ENV_NAME="preview"
            HARBOR_PROJECT="$PREVIEW_PROJECT"
            IMAGE_TAG=$(echo "$BRANCH_NAME" | sed -E 's#[^a-zA-Z0-9]+#-#g' | tr '[:upper:]' '[:lower:]')-preview
            HARBOR_USER=$harbor_preview_user
            HARBOR_PASS=$harbor_preview_pass
          fi

          echo "ENV_NAME=$ENV_NAME" >> $GITHUB_ENV
          echo "HARBOR_PROJECT=$HARBOR_PROJECT" >> $GITHUB_ENV
          echo "COMPONENT_NAME=$COMPONENT_NAME" >> $GITHUB_ENV
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "HARBOR_USER=$HARBOR_USER" >> $GITHUB_ENV
          echo "HARBOR_PASS=$HARBOR_PASS" >> $GITHUB_ENV

      - name: Login to Harbor
        run: echo "$HARBOR_PASS" | docker login $CONTAINER_REGISTRY -u $HARBOR_USER --password-stdin

      - name: Build Docker Image
        run: |
          IMAGE=$CONTAINER_REGISTRY/$HARBOR_PROJECT/$COMPONENT_NAME:$IMAGE_TAG
          docker build -t $IMAGE .

      - name: Push Docker Image
        run: |
          IMAGE=$CONTAINER_REGISTRY/$HARBOR_PROJECT/$COMPONENT_NAME:$IMAGE_TAG
          docker push $IMAGE
